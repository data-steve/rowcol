---
task_id: latest-safe-pay-date-2025-09-24
objective: "Implement comprehensive 'Latest Safe Pay Date' calculation in BillService"
status: "pending"
log:
  - entry: "Task created from ENGINEERING_BACKLOG.md"
    timestamp: "2025-09-24T20:30:00Z"

# --- INPUTS ---
# Raw user notes, complaints, ideas, questions. Use @document to add to this section.
inputs: |
  - Need to implement 'Latest Safe Pay Date' calculation as a core Smart AP feature
  - This is needed to justify Smart AP as a $99/mo add-on (from build plan line 140)
  - Current implementation in BillService is basic (just due_date + grace_days)
  - Need to enhance with vendor-specific terms, business rules, and risk assessment
  - Should integrate with existing payment_rules.py and risk_assessment_rules.py

# --- DIAGNOSIS ---
# Root cause analysis, evidence, and links to existing code. Generated by @diagnose.
diagnosis: |
  - **Current State**: Basic implementation exists in `domains/ap/services/bill_ingestion.py` line 353-370
  - **Gap**: Current logic is too simple - only uses due_date + grace_days
  - **Missing**: Vendor-specific payment terms, business rules integration, risk-based adjustments
  - **Architecture**: BillService is the right place, but needs enhancement with business rules
  - **Dependencies**: PaymentRules, RiskAssessmentRules, Vendor model payment terms
  - **Integration Points**: 
    - `domains/ap/models/vendor.py` has `terms` field (line 37)
    - `config/business_rules/payment_rules.py` has comprehensive payment timing rules
    - `config/business_rules/risk_assessment_rules.py` has vendor reliability scoring

# --- PROPOSED SOLUTION ---
# High-level plan of attack. Generated by @solution.
solution: |
  - **Enhance BillService.calculate_latest_safe_pay_date()** with comprehensive logic
  - **Integrate business rules** from PaymentRules and RiskAssessmentRules
  - **Add vendor-specific calculations** using Vendor.terms field
  - **Implement risk-based adjustments** using vendor reliability scores
  - **Add configuration options** for grace periods and business preferences
  - **Create comprehensive tests** covering all business rule scenarios
  - **Add logging and metrics** for payment optimization insights

# --- PLAN ---
# The final, executable plan. Generated by @plan and used by @build.
# This block is read by auto.py
plan:
  files_to_touch:
    - domains/ap/services/bill_ingestion.py
    - domains/ap/services/payment.py
    - config/business_rules/payment_rules.py
    - tests/domains/ap/test_bill_service.py
    - tests/domains/ap/test_payment_service.py
  edits:
    - "domains/ap/services/bill_ingestion.py:353-370:Replace basic calculate_latest_safe_pay_date with comprehensive implementation"
    - "domains/ap/services/payment.py:Add helper method to get vendor payment terms and reliability"
    - "config/business_rules/payment_rules.py:Add VENDOR_TERMS_PARSING constants and methods"
    - "tests/domains/ap/test_bill_service.py:Add comprehensive test cases for all business rule scenarios"
    - "tests/domains/ap/test_payment_service.py:Add tests for vendor payment terms integration"
  tests:
    - "pytest -q -k 'test_calculate_latest_safe_pay_date'"
    - "pytest -q -k 'test_payment_terms_parsing'"
    - "pytest -q -k 'test_vendor_reliability_integration'"
  verification:
    - "python -c 'from domains.ap.services.bill_ingestion import BillService; print(\"Import successful\")'"
    - "python -c 'from config.business_rules.payment_rules import PaymentRules; print(\"Business rules accessible\")'"
  rollback:
    - "git restore domains/ap/services/bill_ingestion.py"
    - "git restore config/business_rules/payment_rules.py"
  risk_notes:
    - "Low risk: Enhancing existing method, not changing interface"
    - "Business logic changes: Ensure all calculations align with PaymentRules"
    - "Performance: New calculations may be more complex, monitor query performance"

# --- TASK DETAILS ---
# Detailed implementation requirements and specifications

## Business Requirements
- **Primary Goal**: Calculate the latest safe payment date for bills considering vendor terms, business rules, and risk factors
- **Business Value**: Enables Smart AP as $99/mo add-on by providing intelligent payment timing
- **User Story**: "As a service agency owner, I want to know the latest safe date to pay each bill so I can optimize my cash flow without damaging vendor relationships"

## Technical Requirements

### Core Functionality
1. **Vendor Terms Parsing**: Parse vendor payment terms (Net 30, 2/10 Net 30, etc.)
2. **Business Rules Integration**: Apply PaymentRules and RiskAssessmentRules
3. **Risk-Based Adjustments**: Adjust dates based on vendor reliability scores
4. **Grace Period Management**: Configurable grace periods for different vendor types
5. **Early Payment Discounts**: Identify opportunities for early payment discounts

### Method Signature
```python
def calculate_latest_safe_pay_date(
    self, 
    bill: Bill, 
    grace_days: int = None,
    consider_vendor_terms: bool = True,
    consider_risk_factors: bool = True,
    consider_early_discounts: bool = True
) -> Optional[datetime]:
```

### Business Logic Flow
1. **Base Calculation**: Start with bill.due_date
2. **Vendor Terms**: Apply vendor-specific payment terms from Vendor.terms
3. **Business Rules**: Apply PaymentRules based on vendor type and reliability
4. **Risk Assessment**: Adjust based on vendor reliability score
5. **Early Discounts**: Check for early payment discount opportunities
6. **Grace Period**: Apply appropriate grace period based on vendor tier
7. **Validation**: Ensure date is not in the past and is reasonable

### Integration Points
- **Vendor Model**: Use Vendor.terms, payment_reliability_score, is_critical
- **PaymentRules**: Use vendor tier thresholds and payment timing rules
- **RiskAssessmentRules**: Use vendor reliability scoring and payment strategies
- **Bill Model**: Use bill.due_date, amount, vendor relationship

### Test Scenarios
1. **Basic Scenarios**: Standard Net 30 terms, no special conditions
2. **Vendor Tiers**: Strategic, standard, and commodity vendor handling
3. **Risk Factors**: High, medium, low reliability vendors
4. **Early Discounts**: 2/10 Net 30 scenarios
5. **Edge Cases**: Missing due dates, invalid terms, past due bills
6. **Business Rules**: Amount thresholds, approval requirements

### Success Criteria
- [ ] Method handles all vendor term formats (Net 30, 2/10 Net 30, etc.)
- [ ] Business rules are properly applied based on vendor tier and reliability
- [ ] Risk-based adjustments work correctly
- [ ] Early payment discount opportunities are identified
- [ ] All test scenarios pass
- [ ] Performance is acceptable (< 100ms per calculation)
- [ ] Integration with existing BillService is seamless

### Future Enhancements (Not in Scope)
- Machine learning-based payment timing optimization
- Integration with external credit scoring services
- Advanced cash flow forecasting integration
- Real-time vendor relationship health monitoring
