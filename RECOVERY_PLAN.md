# Oodaloo Codebase Recovery Plan (Granular Replay)

**Date:** 2025-09-24

**Status:** In Progress

## 1. Summary

This document provides a detailed, chronological list of tasks required to restore the codebase. It is generated by "replaying" the session log (`cursor_audit_and_update_build_plan_for.md`) from the point where the local files diverged from the completed work.

Each task must be completed in order to ensure the foundational code for subsequent tasks is present.

## 2. Recovery Task List (Chronological)

---

### **Task 1: Correct Test Fixture `qbo_connected_business`**

-   **Session Log Reference:** Lines `~46866` - `~47170`
-   **Description:** The test fixture was creating a business with a hardcoded `business_id` (e.g., `"test_qbo_business_id"`). This caused token validation to fail because the tokens in `dev_tokens.json` are associated with the real `QBO_REALM_ID`. The fix is to make the fixture use the `QBO_REALM_ID` from the `.env` file for the `business_id`.
-   **Affected Files:**
    -   `tests/conftest.py`
-   **Status:** `Pending Re-implementation`

---

### **Task 2: Correct `intuit-oauth` Package Imports**

-   **Session Log Reference:** Lines `~47495` - `~47750`
-   **Description:** The codebase has reverted to using an incorrect import for the QBO authentication client (`from intuitoauth import AuthClient`). This needs to be corrected to the proper `from intuitlib.client import AuthClient` and `from intuitlib.enums import Scopes`. This is a critical fix to get the real QBO API calls working. [[memory:9291494]]
-   **Affected Files:**
    -   `domains/integrations/qbo/auth.py`
    -   `domains/integrations/qbo/get_qbo_tokens.py`
-   **Status:** `Pending Re-implementation`

---

### **Task 3: Fix SQLAlchemy Transaction Conflict in Token Refresh**

-   **Session Log Reference:** Lines `~48022` - `~48437`
-   **Description:** The `_refresh_real_token` method in `QBOAuthService` incorrectly tries to start a new database transaction (`with self.db.begin():`) when one is already active from the pytest fixture. This causes tests to fail with a `A transaction is already begun on this Session` error. The fix involves removing the `with` block and letting the existing test transaction manage the commit.
-   **Affected Files:**
    -   `domains/integrations/qbo/auth.py`
-   **Status:** `Pending Re-implementation`

---

### **Task 4: Rename `QBOAPIProvider` to `QBOAPIClient` System-Wide**

-   **Session Log Reference:** Lines `~49379` onwards.
-   **Description:** A major architectural decision was made to rename `QBOAPIProvider` to `QBOAPIClient` to eliminate confusion with the mock "provider" pattern. This included renaming the factory functions from `get_qbo_provider` to `get_qbo_client` via a comprehensive series of fin and replace. This was a far-reaching change that touched dozens of files.
-   **Affected Files:**
    -   `domains/integrations/qbo/client.py` (class and function definitions)
    -   `domains/integrations/qbo/__init__.py`
    -   `domains/integrations/qbo/service.py`
    -   `domains/integrations/qbo/scenario_runner.py`
    -   `domains/integrations/qbo/health.py`
    -   `domains/ap/services/bill_ingestion.py`
    -   `tests/integration/test_foundation_e2e.py`
    -   ...and many others. The log must be reviewed for a full list.
-   **Status:** `Pending Re-implementation`

---

### **Task 5: Code & Directory Cleanup**

-   **Session Log Reference:** Lines `~49445` - `~50500`
-   **Description:** A major cleanup of unused files and directories was performed. The state of this cleanup has been partially lost and needs to be verified and completed.
-   **Sub-Tasks & Status:**
    -   **Delete `domains/core/services/data_ingestion.py`**: The file was identified as unused and deleted.
    -   **Delete `_parked/` directory**: The directory was identified as obsolete and deleted.
    -   **Move `plaid_identity_graph` to `domains/integrations/plaid/`**: The `identity_graph` code was not moved before its parent `_parked` directory was deleted. This code must be recovered from the session log.
-   **Affected Files:**
    -   `domains/core/services/data_ingestion.py` (to be deleted)
    -   `_parked/` (to be deleted)
    -   `domains/integrations/plaid/identity_graph/` (to be restored from log)
-   **Status:** `Partial Re-implementation Required`

---

### **Task 6: Enhance `validate_imports.py` with Comprehensive Checks**

-   **Session Log Reference:** Lines `~54425` - `~62832`
-   **Description:** The import validation script was significantly upgraded to perform a comprehensive check of ~24 import groups across the entire codebase. This involved adding a `verify_comprehensive_imports` function and a `--verify-all` CLI flag. This work was completely lost and the script reverted to its old, simpler version.
-   **Affected Files:**
    -   `scripts/validate_imports.py`
-   **Status:** `Pending Re-implementation`

---

### **Task 7: Re-implement P0-P2 Implementation Audit Fixes**

-   **Session Log Reference:** Various, from `~15907` onwards.
-   **Description:** The session log and the current TODO list show that we successfully fixed all P0, P1, and P2 issues from the `IMPLEMENTATION_AUDIT.md`. This includes fixing the hardcoded `"api_user"`, making the Tray and Payment routes return real data, implementing vendor/customer lookups, and fixing the hardcoded onboarding status. All of this work has reverted and must be re-implemented.
-   **Affected Files:**
    -   `runway/routes/bills.py`
    -   `runway/routes/reserve_runway.py`
    -   `runway/experiences/tray.py`
    -   `runway/routes/payments.py`
    -   `domains/ap/services/vendor.py`
    -   `runway/routes/vendors.py`
    -   `domains/ar/services/customer.py`
    -   `domains/ar/services/collections.py`
    -   `runway/experiences/onboarding.py`
-   **Status:** `Pending Re-implementation`

---
