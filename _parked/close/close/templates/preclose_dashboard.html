<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-Close Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        .pane { height: 100vh; overflow-y: auto; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex pane">
        <div class="w-1/4 p-4 bg-white border-r">
            <h2 class="text-lg font-bold mb-4">Pre-Close Lanes</h2>
            <div class="mb-4">
                <h3 class="font-semibold">PBC Missing</h3>
                <ul id="pbc-missing-lane" class="space-y-2"></ul>
            </div>
            <div>
                <h3 class="font-semibold">Exceptions</h3>
                <ul id="exceptions-lane" class="space-y-2"></ul>
            </div>
        </div>
        <div class="w-1/2 p-4 bg-white">
            <h2 class="text-lg font-bold mb-4">Details</h2>
            <div id="item-details"></div>
            <p id="no-item" class="hidden">No item selected</p>
        </div>
        <div class="w-1/4 p-4 bg-white border-l">
            <h2 class="text-lg font-bold mb-4">Actions</h2>
            <div id="actions" class="space-y-2"></div>
            <div class="mt-4">
                <h3 class="font-semibold">Binder Status</h3>
                <p id="binder-status"></p>
            </div>
            <div class="mt-4">
                <h3 class="font-semibold">SLA Alerts</h3>
                <p id="sla-alerts"></p>
            </div>
        </div>
    </div>
    <script>
        const firmId = "550e8400-e29b-41d4-a716-446655440000";
        const clientId = 1;
        const period = new Date().toISOString();
        let selectedItem = null;

        async function loadLanes() {
            try {
                const pbcResponse = await axios.get('/api/close/checks/pbc', { params: { firm_id: firmId, client_id: clientId, period } });
                const exceptionsResponse = await axios.get('/api/close/checks/exceptions', { params: { firm_id: firmId, client_id: clientId, period } });
                
                const pbcMissing = pbcResponse.data.filter(p => p.status !== 'received');
                const pbcList = document.getElementById('pbc-missing-lane');
                pbcList.innerHTML = pbcMissing.map(p => `<li class="p-2 cursor-pointer" data-type="pbc" data-id="${p.request_id}">${p.item_type} (Due: ${new Date(p.due_date).toLocaleDateString()})</li>`).join('');
                
                const exceptionsList = document.getElementById('exceptions-lane');
                exceptionsList.innerHTML = exceptionsResponse.data.filter(e => !e.resolution).map(e => `<li class="p-2 cursor-pointer" data-type="exception" data-id="${e.exception_id}">${e.description}</li>`).join('');

                document.querySelectorAll('#pbc-missing-lane li, #exceptions-lane li').forEach(item => {
                    item.addEventListener('click', () => selectItem(item.dataset.type, item.dataset.id));
                });

                document.getElementById('binder-status').innerText = `Pending: ${pbcMissing.length} PBCs, ${exceptionsResponse.data.filter(e => !e.resolution).length} Exceptions`;
                document.getElementById('sla-alerts').innerText = pbcMissing.filter(p => new Date(p.due_date) < new Date()).length ? 'Overdue PBCs detected!' : 'All PBCs on track';
            } catch (error) {
                document.getElementById('item-details').innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
            }
        }

        async function selectItem(type, id) {
            try {
                selectedItem = { type, id };
                const details = document.getElementById('item-details');
                const noItem = document.getElementById('no-item');
                noItem.classList.add('hidden');
                details.classList.remove('hidden');

                if (type === 'pbc') {
                    const response = await axios.get(`/api/close/checks/pbc/${id}`, { params: { firm_id: firmId } });
                    const pbc = response.data;
                    details.innerHTML = `
                        <p><strong>Type:</strong> ${pbc.item_type}</p>
                        <p><strong>Status:</strong> ${pbc.status}</p>
                        <p><strong>Due:</strong> ${new Date(pbc.due_date).toLocaleDateString()}</p>
                        <p><strong>Owner:</strong> ${pbc.owner}</p>
                    `;
                    document.getElementById('actions').innerHTML = `
                        <button onclick="updatePBC(${id}, 'received')" class="w-full bg-green-500 text-white p-2 rounded">Mark Received</button>
                        <button onclick="sendReminder(${id})" class="w-full bg-blue-500 text-white p-2 rounded">Send Reminder</button>
                    `;
                } else {
                    const response = await axios.get(`/api/close/checks/exceptions/${id}`, { params: { firm_id: firmId } });
                    const exception = response.data;
                    details.innerHTML = `
                        <p><strong>Type:</strong> ${exception.type}</p>
                        <p><strong>Description:</strong> ${exception.description}</p>
                        <p><strong>Resolution:</strong> ${exception.resolution || 'Pending'}</p>
                    `;
                    document.getElementById('actions').innerHTML = `
                        <button onclick="resolveException(${id})" class="w-full bg-green-500 text-white p-2 rounded">Resolve</button>
                    `;
                }
            } catch (error) {
                document.getElementById('item-details').innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
            }
        }

        async function updatePBC(id, status) {
            try {
                await axios.patch(`/api/close/checks/pbc/${id}`, { status }, { params: { firm_id: firmId } });
                loadLanes();
            } catch (error) {
                alert(`Failed to update PBC: ${error.message}`);
            }
        }

        async function sendReminder(id) {
            try {
                await axios.post(`/api/close/checks/pbc/${id}/reminder`, {}, { params: { firm_id: firmId } });
                alert('Reminder sent');
            } catch (error) {
                alert(`Failed to send reminder: ${error.message}`);
            }
        }

        async function resolveException(id) {
            try {
                const resolution = prompt('Enter resolution:');
                if (resolution) {
                    await axios.patch(`/api/close/checks/exceptions/${id}`, { resolution }, { params: { firm_id: firmId } });
                    loadLanes();
                }
            } catch (error) {
                alert(`Failed to resolve exception: ${error.message}`);
            }
        }

        loadLanes();
    </script>
</body>
</html>
