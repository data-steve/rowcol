<!DOCTYPE html>
<html>
<head>
    <title>Engagements</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const EngagementCard = ({ engagement, tasks, onUpdateStatus, onSyncQbo }) => {
            const [showDetails, setShowDetails] = React.useState(false);
            return (
                <div className="border rounded-lg p-4 mb-4 shadow">
                    <h2 className="text-lg font-bold">Engagement #{engagement.engagement_id}</h2>
                    <p>Status: <span className={`inline-block px-2 py-1 rounded ${engagement.status === 'pending' ? 'bg-yellow-200' : engagement.status === 'active' ? 'bg-blue-200' : 'bg-green-200'}`}>{engagement.status}</span></p>
                    <p>Compliance: <span className={`inline-block px-2 py-1 rounded ${engagement.compliance_status === 'pass' ? 'bg-green-200' : 'bg-red-200'}`}>{engagement.compliance_status}</span></p>
                    <p>QBO Sync: {engagement.qbo_sync_status}</p>
                    <button onClick={() => setShowDetails(!showDetails)} className="text-blue-500">Toggle Details</button>
                    {showDetails && (
                        <div className="mt-2 p-2 bg-gray-100 rounded">
                            <p>Due: {new Date(engagement.due_date).toLocaleDateString()}</p>
                            <p>Tasks:</p>
                            <div>
                                {tasks.map((task, index) => (
                                    <div key={task.task_id} className="border p-2 mb-2 bg-white rounded">
                                        {task.type} - Priority: {task.priority_score.toFixed(2)}
                                        {task.blockers && task.blockers.length > 0 && (
                                            <span className="text-red-500"> (Blocked)</span>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    <div className="mt-2">
                        <button onClick={() => onUpdateStatus(engagement.engagement_id, 'active')} className="bg-blue-500 text-white px-4 py-2 rounded mr-2">Activate</button>
                        <button onClick={() => onSyncQbo(engagement.engagement_id)} className="bg-purple-500 text-white px-4 py-2 rounded mr-2">Sync QBO</button>
                        <a href={`/templates/engagement_letter.html`} className="bg-gray-500 text-white px-4 py-2 rounded">View Letter</a>
                    </div>
                </div>
            );
        };

        const EngagementTraveler = () => {
            const [engagements, setEngagements] = React.useState([]);
            const [tasks, setTasks] = React.useState({});

            React.useEffect(() => {
                fetch('/api/engagements?firm_id=00000000-0000-0000-0000-000000000001')
                    .then(res => res.json())
                    .then(data => {
                        console.log('Fetched engagements:', data);
                        setEngagements(data);
                        data.forEach(e => {
                            fetch(`/api/tasks?engagement_id=${e.engagement_id}&firm_id=00000000-0000-0000-0000-000000000001`)
                                .then(res => res.json())
                                .then(taskData => {
                                    console.log(`Fetched tasks for engagement ${e.engagement_id}:`, taskData);
                                    setTasks(t => ({ ...t, [e.engagement_id]: taskData }));
                                });
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching engagements:', error);
                    });
            }, []);

            const updateStatus = (engagement_id, status) => {
                fetch(`/api/engagements/${engagement_id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                })
                    .then(res => res.json())
                    .then(updated => setEngagements(engs => engs.map(e => e.engagement_id === updated.engagement_id ? updated : e)));
            };

            const syncQbo = (engagement_id) => {
                fetch(`/api/engagements/${engagement_id}/qbo-sync`, { method: 'POST' })
                    .then(res => res.text())
                    .then(() => fetch('/api/engagements').then(res => res.json()).then(data => setEngagements(data)));
            };

            return (
                <div className="container mx-auto p-4">
                    <div className="flex">
                        <nav className="w-1/5 p-4">
                            <ul>
                                <li>Intake</li>
                                <li>Engagements</li>
                                <li>Reconciliation</li>
                                <li>Review</li>
                                <li>Portals</li>
                            </ul>
                        </nav>
                        <div className="w-4/5">
                            <div className="flex justify-between mb-4">
                                <div className="bg-blue-100 p-2 rounded">Overdue: 2</div>
                                <div className="bg-green-100 p-2 rounded">Compliance Pass: 95%</div>
                                <div className="bg-purple-100 p-2 rounded">Automation Ready: 80%</div>
                            </div>
                            <h1 className="text-2xl font-bold mb-4">Engagement Traveler</h1>
                            <div className="flex mb-4">
                                {['Intake', 'Reconcile', 'Review', 'Finalize'].map(step => (
                                    <span key={step} className="px-2 py-1 bg-gray-200 rounded mr-2">{step}</span>
                                ))}
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {engagements.map(engagement => (
                                    <EngagementCard
                                        key={engagement.engagement_id}
                                        engagement={engagement}
                                        tasks={tasks[engagement.engagement_id] || []}
                                        onUpdateStatus={updateStatus}
                                        onSyncQbo={syncQbo}
                                    />
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<EngagementTraveler />, document.getElementById('root'));
    </script>
</body>
</html>